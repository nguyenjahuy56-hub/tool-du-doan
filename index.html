<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tool Auto D·ª± ƒêo√°n VIP (k√®m Key Lock) - Updated</title>
    <style>
        :root { --panel-scale: 1; --accent: #3366ff; --glass: rgba(32,36,45,0.6); --card:#0f1720; }
        html,body { margin:0;padding:0;height:100%;background:#0d0d12;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;color:#fff; }
        /* ---------- ENTRY / DASHBOARD (overlay) ---------- */
        .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.7), rgba(2,6,12,0.85)); z-index:20000; }
        .panel-card {
            width:420px; max-width:94vw; border-radius:14px; padding:22px; box-shadow:0 18px 60px rgba(0,0,0,0.7);
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border:1px solid rgba(255,255,255,0.04);
            backdrop-filter: blur(6px);
        }
        .panel-card h2 { margin:0 0 6px 0; font-size:18px; text-align:center; }
        .sub { font-size:13px; color:#bdbdbd; text-align:center; margin-bottom:12px; }
        .price-grid { display:flex; gap:8px; justify-content:space-between; margin:12px 0; }
        .price-item { flex:1; background:rgba(255,255,255,0.02); padding:10px;border-radius:8px;text-align:center;font-weight:600; border:1px solid rgba(255,255,255,0.03); }
        .input-row { display:flex; gap:8px; margin-top:10px; }
        input[type="text"]{ flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.45);color:#fff;outline:none; }
        .btn { padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(180deg,var(--accent),#234ed6); color:#fff; }
        .btn-ghost { background:transparent;border:1px solid rgba(255,255,255,0.06); color:#ddd; }
        .msg { text-align:center; margin-top:10px; min-height:20px; font-size:14px; }
        .msg.success { color:#9effc9; }
        .msg.error { color:#ff9ea6; }
        .small { font-size:12px;color:#aab; text-align:center; margin-top:8px; }

        /* ---------- TOOL (kept original look) ---------- */
        #game-frame { width:100%; height:100vh; border: none; display:block; filter:none; }
        #toggle-tool { position:fixed; top:15px; right:15px; z-index:10000; padding:10px 14px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:none; }
        #tool-panel {
            position:absolute; top:15px; right:15px; width:340px; min-width:240px; min-height:120px;
            background: rgba(20, 24, 34, 0.95); color: #fff; padding: 0;
            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.8);
            border: 1px solid #333; z-index:9999; overflow: hidden;
            backdrop-filter: blur(10px);
            resize: both; transform-origin: top right; transform: scale(var(--panel-scale)); touch-action:none;
            display:none; /* hidden until user opens game */
        }
        .panel-header { background: linear-gradient(90deg, #ff3333, var(--accent)); padding:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; border-top-left-radius:12px; border-top-right-radius:12px; }
        .header-left { display:flex; gap:8px; align-items:center; }
        .header-title { font-weight:700; }
        .expire-badge { font-size:12px; background:rgba(255,255,255,0.05); padding:6px 8px; border-radius:8px; color:#ffd; }
        .panel-body { padding:12px; overflow:auto; max-height:calc(100% - 56px); display:flex; flex-direction:column; gap:12px; }
        #btn-auto{ width:100%; padding:12px; background:linear-gradient(180deg,#ffd700,#ffaa00); color:#000; font-weight:700; border:none; border-radius:8px; cursor:pointer; }
        .select-row { display:flex; gap:8px; align-items:center; }
        .seq-text{ letter-spacing:3px; font-family:monospace; color:#ffd700; font-weight:700; }

        /* same internal styles kept */
        .info-row { background:#1a1e29;padding:10px;border-radius:8px;font-size:14px;border:1px solid #2a2f3a; }
        .bar-container { width:100%;height:28px;background:#222;border-radius:12px;display:flex;overflow:hidden;border:1px solid #444; }
        .bar-tai{height:100%;display:flex;align-items:center;padding-left:10px;background:#ff4d4d;color:#000}
        .bar-xiu{height:100%;display:flex;align-items:center;justify-content:flex-end;padding-right:10px;background:#4da6ff;color:#000}
        .pred-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .pred-box{background:#1a1e29;padding:10px;border-radius:8px;text-align:center;border:1px solid #333;}
        .pred-final{grid-column:span 2;background:linear-gradient(45deg,#2a2a3a,#1a1e29);border:1px solid #ffd700;padding:12px;}
        .hint-box{text-align:center;font-size:14px;color:#fff;background:rgba(255,255,255,0.03);padding:8px;border-radius:6px;}

        .control-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .tiny { font-size:12px; color:#cfcfcf; }
        .toggle-btn { padding:6px 8px; border-radius:8px; border:1px solid #444; background:transparent; color:#fff; cursor:pointer; }
        .toggle-btn.active { background:#2a2a3a; border-color:#888; }

        /* responsive */
        @media (max-width:720px) {
            #toggle-tool { display:block; right:12px; top:12px; }
            #tool-panel{ left:8px; right:8px; width:auto; min-width:auto; transform-origin:top center; }
            .panel-body{ padding:10px; max-height:60vh; }
        }
    </style>
</head>
<body>

    <!-- ===== Entry screen: key input + pricing ===== -->
    <div id="entryOverlay" class="overlay" role="dialog" aria-modal="true">
        <div class="panel-card" role="document" aria-labelledby="entryTitle">
            <h2 id="entryTitle">üîê K√≠ch ho·∫°t c√¥ng c·ª• VIP</h2>
            <div class="sub">Nh·∫≠p key ƒë·ªÉ s·ª≠ d·ª•ng. N·∫øu ch∆∞a c√≥ key, li√™n h·ªá admin. B·∫£ng gi√°:</div>

            <div class="price-grid" aria-hidden="false">
                <div class="price-item">
                    <div style="font-size:14px;color:#ffd;">49k</div>
                    <div style="font-size:12px;color:#bdbdbd">1 Day</div>
                </div>
                <div class="price-item">
                    <div style="font-size:14px;color:#ffd;">99k</div>
                    <div style="font-size:12px;color:#bdbdbd">7 Days</div>
                </div>
                <div class="price-item">
                    <div style="font-size:14px;color:#ffd;">199k</div>
                    <div style="font-size:12px;color:#bdbdbd">30 Days</div>
                </div>
            </div>

            <div style="margin-top:6px">
                <label class="small">Nh·∫≠p Key</label>
                <div class="input-row">
                    <input id="keyInput" type="text" placeholder="Nh·∫≠p key c·ªßa b·∫°n..." autocomplete="off" />
                    <button id="checkBtn" class="btn">KI·ªÇM TRA</button>
                </div>
                <div id="entryMsg" class="msg"></div>
                <div class="small">L∆∞u √Ω: key ch·ªâ d√πng cho 1 thi·∫øt b·ªã. N·∫øu c·∫ßn reset, admin s·∫Ω reset HWID.</div>
            </div>
        </div>
    </div>

    <!-- ===== Dashboard after valid key (M·ªû GAME) ===== -->
    <div id="dashOverlay" class="overlay" style="display:none;">
        <div class="panel-card">
            <h2>‚úÖ Key h·ª£p l·ªá</h2>
            <div class="sub" id="dashSub">Key c·ªßa b·∫°n c√≤n: <span id="timeLeft">--:--:--</span></div>
            <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
                <button id="openGameBtn" class="btn" style="background:linear-gradient(180deg,#00c853,#00b44a)">M·ªû GAME</button>
                <button id="backBtn" class="btn-ghost">Quay l·∫°i</button>
            </div>
            <div id="dashMsg" class="msg"></div>
        </div>
    </div>

    <!-- ============ GAME + TOOL ============ -->
    <iframe id="game-frame" src="about:blank" style="width:100%;height:100vh;border:0;display:none;"></iframe>
    <button id="toggle-tool" onclick="togglePanel()">M·ªû TOOL</button>

    <div id="tool-panel" aria-hidden="true">
        <div class="panel-header" id="panel-header">
            <div class="header-left">
                <div class="header-title">üéØ B·∫¢NG D·ª∞ ƒêO√ÅN VIP</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
                <div id="expireBadge" class="expire-badge" title="Th·ªùi h·∫°n key">Key: --</div>
                <div class="controls">
                    <button class="icon" title="Thu nh·ªè" onclick="changeScale(-0.1)">‚àí</button>
                    <button class="icon" title="Ph√≥ng to" onclick="changeScale(0.1)">+</button>
                    <button class="icon" title="Reset" onclick="resetScale()">R</button>
                    <button class="icon" id="orientBtn" title="Chuy·ªÉn ngang / d·ªçc" onclick="toggleOrientation()">‚Üî</button>
                    <button class="close-btn" onclick="togglePanel()">√ó</button>
                </div>
            </div>
        </div>

        <div class="panel-body" id="panel-body">
            <div style="flex: 0 0 100%;">
                <button id="btn-auto" onclick="fetchApiAndPredict()">üîÑ C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU C·∫¶U</button>
            </div>

            <div class="select-row">
                <label for="seq-length-select">ƒê·ªô d√†i chu·ªói:</label>
                <select id="seq-length-select">
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13" selected>13</option>
                    <option value="14">14</option>
                </select>
            </div>

            <div class="select-row">
                <label for="api-source-select">Ch·ªçn b√†n:</label>
                <select id="api-source-select">
                    <option value="normal">B√†n th∆∞·ªùng</option>
                    <option value="md5">B√†n MD5</option>
                </select>
            </div>

            <!-- NEW CONTROLS ADDED (kept minimal, non-invasive) -->
            <div class="control-row tiny">
                <label><input type="checkbox" id="skip-dice-checkbox" /> B·ªè ph√¢n t√≠ch x√∫c x·∫Øc (lo·∫°i b·ªè ·∫£nh h∆∞·ªüng c·ªßa x√∫c x·∫Øc)</label>
                <label><input type="checkbox" id="hide-suggestion-checkbox" /> ·∫®n g·ª£i √Ω ƒë√°nh</label>
            </div>

            <button id="btn-advanced-toggle" class="toggle-btn" style="width:100%;">‚öô N√¢ng cao</button>

            <div id="advanced-section" style="display:none;">
                <div class="control-row tiny">
                    <label><input type="checkbox" id="invert-chain-checkbox" /> B·∫ª ph√¢n t√≠ch chu·ªói (ƒë·∫£o T/X trong ph√¢n t√≠ch chu·ªói)</label>
                    <label><input type="checkbox" id="invert-final-checkbox" /> B·∫ª k·∫øt qu·∫£ t·ªïng h·ª£p (ƒë·∫£o k·∫øt qu·∫£ cu·ªëi)</label>
                </div>

                <div class="control-row">
                    <button id="btn-invert-all" class="toggle-btn">ƒê·∫£o c·∫ßu (To√†n b·ªô)</button>
                    <button id="btn-invert-chain" class="toggle-btn">ƒê·∫£o c·∫ßu (Ch·ªâ chu·ªói)</button>
                    <div style="flex:1"></div>
                </div>
            </div>

            <div class="select-row" style="align-items:flex-start; gap:10px;">
                <label style="align-self:flex-start;">Ch√∫ th√≠ch:</label>
                <textarea id="annotation-input" rows="2" style="flex:1; padding:8px; border-radius:8px; background:rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.04); color:#fff; resize:vertical;" placeholder="Th√™m ch√∫ th√≠ch / ghi ch√∫ nhanh..."></textarea>
            </div>

            <div id="result-box" style="flex:1 1 auto;">
                <div style="text-align:center;color:#888;padding:20px 0;"><i>Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y b·∫•m c·∫≠p nh·∫≠t...</i></div>
            </div>
        </div>
    </div>

<script>
/* =========================
   CONFIG
   ========================= */
const KEY_SERVER_URL = "https://vip-key-server.onrender.com";

/* =========================
   HWID (device id) l∆∞u localStorage
   ========================= */
function getHWID(){
    let id = localStorage.getItem("device_hw");
    if(!id){
        id = "HW-" + Math.random().toString(36).slice(2,10).toUpperCase();
        localStorage.setItem("device_hw", id);
    }
    return id;
}

/* =========================
   UI elements
   ========================= */
const entryOverlay = document.getElementById("entryOverlay");
const dashOverlay = document.getElementById("dashOverlay");
const entryMsg = document.getElementById("entryMsg");
const checkBtn = document.getElementById("checkBtn");
const keyInput = document.getElementById("keyInput");
const dashMsg = document.getElementById("dashMsg");
const timeLeftEl = document.getElementById("timeLeft");
const openGameBtn = document.getElementById("openGameBtn");
const backBtn = document.getElementById("backBtn");
const expireBadge = document.getElementById("expireBadge");

const gameFrame = document.getElementById("game-frame");
const toolPanel = document.getElementById("tool-panel");
const toggleBtn = document.getElementById("toggle-tool");

/* NEW controls */
const invertChainCheckbox = () => document.getElementById('invert-chain-checkbox');
const invertFinalCheckbox = () => document.getElementById('invert-final-checkbox');
const skipDiceCheckbox = () => document.getElementById('skip-dice-checkbox');
const hideSuggestionCheckbox = () => document.getElementById('hide-suggestion-checkbox');
const annotationInput = () => document.getElementById('annotation-input');
const btnInvertAll = document.getElementById('btn-invert-all');
const btnInvertChain = document.getElementById('btn-invert-chain');

/* =========================
   Helper: show/hide
   ========================= */
function show(el){ el.style.display = ""; }
function hide(el){ el.style.display = "none"; }

/* =========================
   Key check flow (calls server)
   Expected: POST /check-key { key, hwid } -> { success: true/false, message? }
   Then get expiry by GET /keys and find matching key (server must support /keys)
   ========================= */
let currentKey = null;
let expireTimer = null;

async function fetchKeyInfoFromServer(key){
    try{
        const res = await fetch(KEY_SERVER_URL + "/keys");
        if(!res.ok) return null;
        const data = await res.json();
        if(!Array.isArray(data)) return null;
        return data.find(k => k.key === key) || null;
    }catch(e){
        console.error("fetchKeyInfoFromServer err", e);
        return null;
    }
}

function startExpireCountdown(expireTs){
    if(expireTimer) clearInterval(expireTimer);
    function update(){
        const now = Date.now();
        const diff = expireTs - now;
        if(diff <= 0){
            timeLeftEl.innerText = "ƒê√£ h·∫øt h·∫°n";
            expireBadge.innerText = "Key: H·∫øt h·∫°n";
            clearInterval(expireTimer);
            return;
        }
        const totalSec = Math.floor(diff/1000);
        const days = Math.floor(totalSec / 86400);
        const hours = Math.floor((totalSec % 86400) / 3600);
        const mins = Math.floor((totalSec % 3600) / 60);
        const secs = totalSec % 60;
        const str = (days>0? days+"d ":"") + String(hours).padStart(2,"0")+":"+
                    String(mins).padStart(2,"0")+":"+String(secs).padStart(2,"0");
        timeLeftEl.innerText = str;
        expireBadge.innerText = "Key expires: " + (days>0? days+"d ":"") + String(hours).padStart(2,"0")+":"+String(mins).padStart(2,"0");
    }
    update();
    expireTimer = setInterval(update, 1000);
}

async function checkKeyFlow(){
    const key = (keyInput.value || "").trim();
    if(!key){ entryMsg.className="msg error"; entryMsg.innerText="Vui l√≤ng nh·∫≠p key"; return; }
    entryMsg.className="msg"; entryMsg.innerText="ƒêang ki·ªÉm tra...";
    checkBtn.disabled = true;
    try{
        const hwid = getHWID();
        const resp = await fetch(KEY_SERVER_URL + "/check-key", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ key, hwid })
        });
        const data = await resp.json();
        if(data && data.success){
            const info = await fetchKeyInfoFromServer(key);
            if(info && info.expire){
                currentKey = key;
                startExpireCountdown(info.expire);
                entryMsg.className = "msg success";
                entryMsg.innerText = "‚úÖ Key h·ª£p l·ªá. Chuy·ªÉn sang m√†n h√¨nh m·ªü game...";
                setTimeout(()=> {
                    hide(entryOverlay);
                    show(dashOverlay);
                    dashMsg.innerText = "";
                }, 450);
            } else {
                currentKey = key;
                entryMsg.className = "msg success";
                entryMsg.innerText = "‚úÖ Key h·ª£p l·ªá (kh√¥ng c√≥ th√¥ng tin th·ªùi h·∫°n).";
                setTimeout(()=> {
                    hide(entryOverlay);
                    show(dashOverlay);
                    dashMsg.innerText = "";
                    timeLeftEl.innerText = "--:--:--";
                }, 450);
            }
        } else {
            entryMsg.className="msg error";
            entryMsg.innerText = data && data.message ? ("‚ùå " + data.message) : "Key kh√¥ng h·ª£p l·ªá";
        }
    }catch(err){
        console.error(err);
        entryMsg.className="msg error";
        entryMsg.innerText = "L·ªói k·∫øt n·ªëi server";
    } finally {
        checkBtn.disabled = false;
    }
}

/* Enter binding */
keyInput.addEventListener("keydown", (e) => { if(e.key === "Enter") checkKeyFlow(); });
checkBtn.addEventListener("click", checkKeyFlow);

/* Back from dashboard */
backBtn.addEventListener("click", ()=> {
    hide(dashOverlay);
    show(entryOverlay);
    entryMsg.innerText = "";
    keyInput.value = "";
});

/* =========================
   Open Game (only when key validated)
   - loads iframe to game url
   - shows tool panel
   ========================= */
openGameBtn.addEventListener("click", async ()=>{
    if(!currentKey){
        dashMsg.className="msg error"; dashMsg.innerText="Key kh√¥ng h·ª£p l·ªá, h√£y ki·ªÉm tra l·∫°i";
        return;
    }
    try{
        const resp = await fetch(KEY_SERVER_URL + "/check-key", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ key: currentKey, hwid: getHWID() })
        });
        const data = await resp.json();
        if(!(data && data.success)){
            dashMsg.className="msg error"; dashMsg.innerText="Key ƒë√£ b·ªã v√¥ hi·ªáu ho√° ho·∫∑c d√πng tr√™n thi·∫øt b·ªã kh√°c";
            return;
        }
    }catch(e){
        console.warn("recheck err", e);
    }

    gameFrame.src = "https://lc79b.bet/"; // gi·ªØ nguy√™n game g·ªëc
    show(gameFrame);
    hide(dashOverlay);
    setTimeout(()=>{
        toolPanel.style.display = "block";
        toolPanel.setAttribute("aria-hidden","false");
        if(window.innerWidth <= 720) toggleBtn.style.display = "block";
        // ensure panel shows current key expiry immediately
        setPanelKeyInfo();
    }, 300);
});

/* Toggle panel */
function togglePanel(){
    if(toolPanel.style.display === "none" || toolPanel.getAttribute('aria-hidden') === 'true'){
        toolPanel.style.display = "block";
        toolPanel.setAttribute('aria-hidden','false');
        toggleBtn.style.display = "none";
        // update expiry info when panel opens
        setPanelKeyInfo();
    } else {
        toolPanel.style.display = "none";
        toolPanel.setAttribute('aria-hidden','true');
        toggleBtn.style.display = "block";
    }
}

/* =========================
   Show expiry info inside panel when loaded
   ========================= */
function setPanelKeyInfo(){
    if(!currentKey) { expireBadge.innerText = "Key: --"; return; }
    fetchKeyInfoFromServer(currentKey).then(info=>{
        if(info && info.expire){
            startExpireCountdown(info.expire);
        } else {
            expireBadge.innerText = "Key: (no expire)";
        }
    }).catch(()=>{ expireBadge.innerText = "Key: --"; });
}

document.querySelector(".close-btn").addEventListener("click", ()=> { togglePanel(); });

/* =========================
   KEEP ORIGINAL TOOL LOGIC BELOW (unchanged algorithm)
   ========================= */

const GOI_Y_NGUONG = [ [90, "R·∫•t t·ª± tin ƒë·∫∑t"], [70, "N√™n ƒë·∫∑t"], [60, "C√¢n nh·∫Øc"] ];
const NGUONG_TY_LE = 3;

function phanTichChuoiWeighted(chuoi) {
    if (!Array.isArray(chuoi) || chuoi.length === 0) return { ptTai: 50.0, ptXiu: 50.0 };
    const n = chuoi.length;
    const weights = Array.from({length: n}, (_, i) => Math.pow(2, i));
    const chuoiRev = chuoi.slice().reverse();
    let tai = 0, xiu = 0;
    for (let i = 0; i < chuoiRev.length; i++) {
        const c = chuoiRev[i];
        if (c === "T") tai += weights[i];
        if (c === "X") xiu += weights[i];
    }
    const tong_weight = weights.reduce((a,b)=>a+b,0);
    const ptTai = parseFloat(((tai / tong_weight) * 100).toFixed(1));
    const ptXiu = parseFloat(((xiu / tong_weight) * 100).toFixed(1));
    return { ptTai, ptXiu };
}
function goiYDat(du_doan, percent, chenh) {
    for (let i = 0; i < GOI_Y_NGUONG.length; i++) {
        const [threshold, message] = GOI_Y_NGUONG[i];
        if (percent >= threshold) {
            if (percent < 70) {
                return `${message} (v√¨ t·ª∑ l·ªá ch∆∞a cao ho·∫∑c ch√™nh l·ªách nh·ªè)`;
            }
            return message;
        }
    }
    return "B·ªè qua";
}
function demChuoiLienTiep(chuoi, ky_tu) {
    let count = 0;
    for (let i = chuoi.length - 1; i >= 0; i--) {
        if (chuoi[i] === ky_tu) count++;
        else break;
    }
    return count;
}
function phanTichChuKy(chuoi) {
    const Ls = [5,4,3,2];
    for (let idx = 0; idx < Ls.length; idx++) {
        const l = Ls[idx];
        if (chuoi.length >= 2*l) {
            const a = chuoi.slice(chuoi.length - l).join("");
            const b = chuoi.slice(chuoi.length - 2*l, chuoi.length - l).join("");
            if (a === b) return chuoi[chuoi.length - 1];
        }
    }
    return null;
}
function laCauDanXen(chuoi) {
    if (chuoi.length < 6) return false;
    for (let i = chuoi.length - 6; i < chuoi.length - 1; i++) {
        if (chuoi[i] === chuoi[i+1]) return false;
    }
    return true;
}
function phatHienCauBip(chuoi) {
    const tail6 = chuoi.slice(-6).join("");
    const tail5 = chuoi.slice(-5).join("");
    if (tail6 === "TTTTTT" || tail6 === "XXXXXX") return "C·∫ßu b·ªát d√†i b·∫•t th∆∞·ªùng";
    if (tail5 === "TXTXX" || tail5 === "XTXTT") return "C·∫ßu nh·ª≠ ƒë·∫£o 1-1-2";
    if (tail6 === "TXXTXT") return "C·∫ßu b·∫´y l·∫∑p ƒë·ªÅu";
    return null;
}
function duDoanTuChuoi(chuoi) {
    const { ptTai, ptXiu } = phanTichChuoiWeighted(chuoi);
    let diem_tai = 0, diem_xiu = 0;
    for (let l = 7; l >= 3; l--) {
        if (chuoi.length >= l) {
            const tail = chuoi.slice(-l);
            if (tail.every(x => x === "T")) diem_tai += (l - 2) * 2;
            else if (tail.every(x => x === "X")) diem_xiu += (l - 2) * 2;
        }
    }
    const ck = phanTichChuKy(chuoi);
    if (ck === "T") diem_tai += 5;
    else if (ck === "X") diem_xiu += 5;
    if (laCauDanXen(chuoi)) {
        if (chuoi[chuoi.length - 1] === "T") diem_xiu += 4;
        else diem_tai += 4;
    }
    const tail5 = chuoi.slice(-5).join("");
    const mau_cau = {"TTXXT":"T","XXTTX":"X","TXXTX":"T","XTTXT":"X","TXT":"X","XTX":"T","TTX":"X","XXT":"T"};
    for (const k in mau_cau) {
        if (tail5.endsWith(k)) {
            const v = mau_cau[k];
            if (v === "T") diem_tai += 4; else diem_xiu += 4;
        }
    }
    if (ptTai > ptXiu + NGUONG_TY_LE) diem_tai += 4;
    else if (ptXiu > ptTai + NGUONG_TY_LE) diem_xiu += 4;
    const countT = chuoi.filter(c => c === "T").length;
    const countX = chuoi.filter(c => c === "X").length;
    if (countT >= 0.6 * chuoi.length) diem_tai += 2;
    else if (countX >= 0.6 * chuoi.length) diem_xiu += 2;
    const lt_t = demChuoiLienTiep(chuoi, "T");
    const lt_x = demChuoiLienTiep(chuoi, "X");
    if (lt_t >= 3) diem_tai += Math.pow(2, lt_t - 2);
    if (lt_x >= 3) diem_xiu += Math.pow(2, lt_x - 2);
    diem_tai += ptTai / 10;
    diem_xiu += ptXiu / 10;
    if (diem_tai > diem_xiu + 1) return ["T√†i", ptTai, ptXiu];
    else if (diem_xiu > diem_tai + 1) return ["X·ªâu", ptTai, ptXiu];
    return ["Kh√¥ng r√µ", ptTai, ptXiu];
}
function duDoanTuXucXac(dices) {
    if (!dices || !Array.isArray(dices) || dices.length !== 3) return ["Kh√¥ng r√µ", null];
    const tong = Number(dices[0]) + Number(dices[1]) + Number(dices[2]);
    if (tong >= 11 && tong <= 17) return ["T√†i", tong];
    if (tong >= 4 && tong <= 10) return ["X·ªâu", tong];
    return ["Kh√¥ng r√µ", tong];
}
function duDoanTongHop(chuoi, xuc_xac) {
    const phan_chuoi = duDoanTuChuoi(chuoi);
    const kq_chuoi = phan_chuoi[0], pt = phan_chuoi[1], px = phan_chuoi[2];
    let kq_xx = "Kh√¥ng r√µ", tong_xx = null;
    if (xuc_xac && Array.isArray(xuc_xac) && xuc_xac.length === 3) {
        const tmp = duDoanTuXucXac(xuc_xac);
        kq_xx = tmp[0]; tong_xx = tmp[1];
    }
    let ket_qua;
    if (kq_chuoi === kq_xx && kq_chuoi !== "Kh√¥ng r√µ") ket_qua = kq_chuoi;
    else if (kq_chuoi !== "Kh√¥ng r√µ" && (kq_xx === "Kh√¥ng r√µ" || !kq_xx)) ket_qua = kq_chuoi;
    else if (kq_chuoi === "Kh√¥ng r√µ" && kq_xx !== "Kh√¥ng r√µ") ket_qua = kq_xx;
    else ket_qua = "Kh√¥ng r√µ";
    return { ket_qua, phan_tich_chuoi: [kq_chuoi, pt, px], phan_tich_xuc_xac: [kq_xx, tong_xx] };
}

/* =========================
   API + UI helper code for fetching and rendering (unchanged)
   Modified only to respect new toggles (b·∫ª / b·ªè / ch√∫ th√≠ch)
   ========================= */

function getMlsClass(kq) {
    if(kq === "T√†i" || kq === "T") return "color-tai";
    if(kq === "X·ªâu" || kq === "X") return "color-xiu";
    return "";
}
function extractListFromApiResponse(data) {
    if (!data) return [];
    if (Array.isArray(data.list)) return data.list;
    if (Array.isArray(data.data)) return data.data;
    if (Array.isArray(data.items)) return data.items;
    if (Array.isArray(data.lists)) return data.lists;
    if (Array.isArray(data)) return data;
    if (data.data && Array.isArray(data.data.list)) return data.data.list;
    return [];
}
function extractResultFromItem(item) {
    if (!item) return null;
    const keys = ['resultTruyenThong','result','resultText','result_truyen_thong','result_truyen','ketqua','kq'];
    for (const k of keys) {
        if (k in item && item[k] !== undefined && item[k] !== null) {
            const v = String(item[k]).toUpperCase();
            if (v.includes('TAI') || v === 'T' || v === 'T√ÄI' || v === 'TA') return 'T';
            if (v.includes('XIU') || v === 'X' || v === 'X·ªàU' || v === 'XI') return 'X';
        }
    }
    const dices = extractDicesFromItem(item);
    if (Array.isArray(dices) && dices.length === 3) {
        const sum = Number(dices[0]) + Number(dices[1]) + Number(dices[2]);
        if (!isNaN(sum)) {
            if (sum >= 11 && sum <= 17) return 'T';
            if (sum >= 4 && sum <= 10) return 'X';
        }
    }
    if ('point' in item) {
        const p = Number(item.point);
        if (!isNaN(p)) {
            if (p >= 11 && p <= 17) return 'T';
            if (p >= 4 && p <= 10) return 'X';
        }
    }
    return null;
}
function extractDicesFromItem(item) {
    if (!item) return null;
    const keys = ['dices','dice','xuc_xac','xucsac','diceValue','dice_values','d'];
    for (const k of keys) {
        if (k in item && Array.isArray(item[k]) && item[k].length === 3) return item[k];
        if (k in item && typeof item[k] === 'string') {
            const parts = item[k].split(/[^0-9]+/).filter(Boolean).map(Number);
            if (parts.length === 3) return parts;
        }
    }
    if (item.detail && Array.isArray(item.detail.dices)) return item.detail.dices;
    return null;
}

function invertKQ(k){
    if(!k) return k;
    if(k === 'T√†i' || k === 'T' || k === 'TAI' ) return 'X·ªâu';
    if(k === 'X·ªâu' || k === 'X' || k === 'XIU') return 'T√†i';
    return k;
}

async function fetchApiAndPredict() {
    const resultBox = document.getElementById("result-box");
    const btn = document.getElementById("btn-auto");
    const seqSelect = document.getElementById("seq-length-select");
    const apiSelect = document.getElementById("api-source-select");

    btn.innerHTML = "‚è≥ ƒêANG X·ª¨ L√ù...";
    btn.style.opacity = "0.7";

    const DEFAULT_API = "https://wtx.tele68.com/v1/tx/sessions?cp=R&cl=R&pf=web&at=4479e6332082ebf7f206ae3cfcd3ff5e";
    const MD5_API = "https://wtxmd52.tele68.com/v1/txmd5/sessions?cp=R&cl=R&pf=web&at=93b3e543d609af0351163f3ff9a2c495";

    const source = (apiSelect && apiSelect.value) ? apiSelect.value : 'normal';
    let API_URL = (source === 'md5') ? MD5_API : DEFAULT_API;

    try {
        let response = await fetch(API_URL);
        let data = await response.json();

        let list = extractListFromApiResponse(data);

        if (!list || list.length === 0) {
            resultBox.innerHTML = "<div style='color:red; text-align:center;'>L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu API (list r·ªóng)!</div>";
            return;
        }

        let selectedLen = parseInt(seqSelect.value, 10) || 13;

        let ketQuaTuApi = [];
        let maxItems = Math.min(selectedLen, list.length);
        for (let i = 0; i < maxItems; i++) {
            let item = list[i];
            let r = extractResultFromItem(item);
            if (r === 'T') ketQuaTuApi.push("T");
            else if (r === 'X') ketQuaTuApi.push("X");
            else {
                const dices = extractDicesFromItem(item);
                if (Array.isArray(dices) && dices.length === 3) {
                    const s = Number(dices[0]) + Number(dices[1]) + Number(dices[2]);
                    if (!isNaN(s)) {
                        if (s >= 11) ketQuaTuApi.push("T");
                        else ketQuaTuApi.push("X");
                    } else {
                        ketQuaTuApi.push("X");
                    }
                } else {
                    ketQuaTuApi.push("X");
                }
            }
        }

        let chuoiN = ketQuaTuApi.reverse();
        const firstItem = list[0];
        const lastDice = extractDicesFromItem(firstItem) || [];

        // Respect toggles: invert chain, skip dice, etc.
        const invertChain = invertChainCheckbox() && invertChainCheckbox().checked;
        const invertFinal = invertFinalCheckbox() && invertFinalCheckbox().checked;
        const skipDice = skipDiceCheckbox() && skipDiceCheckbox().checked;
        const hideSuggestion = hideSuggestionCheckbox() && hideSuggestionCheckbox().checked;
        const annotation = annotationInput() ? annotationInput().value.trim() : '';

        let chainForAnalysis = chuoiN.slice();
        if(invertChain){
            chainForAnalysis = chainForAnalysis.map(c => c === 'T' ? 'X' : (c === 'X' ? 'T' : c));
        }

        // --- CH·ªñ ƒê√É ƒê∆Ø·ª¢C S·ª¨A: g·ªçi server predict thay v√¨ t√≠nh to√†n b·ªô ·ªü client ---
        let kq_chuoi = "Kh√¥ng r√µ", pt = 50, px = 50;
        try {
            const predictResp = await fetch(KEY_SERVER_URL + "/predict", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ chuoi: chainForAnalysis })
            });
            const predictData = await predictResp.json();
            if (predictData && predictData.success) {
                // server tr·∫£ ptTai / ptXiu v√† ket_qua
                pt = Number(predictData.ptTai);
                px = Number(predictData.ptXiu);
                kq_chuoi = predictData.ket_qua || kq_chuoi;
            } else {
                // fallback: n·∫øu server tr·∫£ l·ªói, d√πng logic c·ª•c b·ªô nh∆∞ tr∆∞·ªõc
                const localPh = duDoanTuChuoi(chainForAnalysis);
                kq_chuoi = localPh[0]; pt = localPh[1]; px = localPh[2];
            }
        } catch (e) {
            // fallback an to√†n n·∫øu server unreachable
            const localPh = duDoanTuChuoi(chainForAnalysis);
            kq_chuoi = localPh[0]; pt = localPh[1]; px = localPh[2];
        }
        // --- K·∫æT TH√öC CH·ªñ S·ª¨A ---

        let kq_xx = "Kh√¥ng r√µ";
        let tong_xx = null;
        if(!skipDice && Array.isArray(lastDice) && lastDice.length === 3){
            const tmp = duDoanTuXucXac(lastDice);
            kq_xx = tmp[0]; tong_xx = tmp[1];
        }

        // If user requested "ƒê·∫£o c·∫ßu (To√†n b·ªô)" button, invert final after composing
        const invertAllActive = btnInvertAll.classList.contains('active');
        const invertChainBtnActive = btnInvertChain.classList.contains('active');

        // If the "ƒê·∫£o c·∫ßu (Ch·ªâ chu·ªói)" button is active, apply chain inversion (redundant with checkbox but button has priority)
        if(invertChainBtnActive && !invertChain) {
            // apply inversion to chainForAnalysis
            chainForAnalysis = chuoiN.map(c => c === 'T' ? 'X' : (c === 'X' ? 'T' : c));
            const tmpP = duDoanTuChuoi(chainForAnalysis);
            kq_chuoi = tmpP[0]; pt = tmpP[1]; px = tmpP[2];
        }

        let ketQuaObj = duDoanTongHop(chainForAnalysis, skipDice ? null : lastDice);
        let ket_qua = ketQuaObj.ket_qua;

        // If user toggled skipDice, force composition to prefer chain
        if(skipDice){
            if(ketQuaObj.phan_tich_chuoi && ketQuaObj.phan_tich_chuoi[0] !== 'Kh√¥ng r√µ') ket_qua = ketQuaObj.phan_tich_chuoi[0];
            else ket_qua = 'Kh√¥ng r√µ';
        }

        // Apply final inversion toggles
        if(invertFinal) ket_qua = invertKQ(ket_qua);
        if(invertAllActive) ket_qua = invertKQ(ket_qua);

        const chenh = Math.abs(pt - px);
        const cau_bip = phatHienCauBip(chuoiN);
        const goi_y = goiYDat(ket_qua, Math.max(pt, px), chenh);

        // Render results (show which toggles active and annotation)
        resultBox.innerHTML = `
            <div class="info-row" style="min-width:140px;">
                <div style="color:#aaa; font-size:12px; margin-bottom:4px;">Ngu·ªìn: <b>${source === 'md5' ? 'B√†n MD5' : 'B√†n th∆∞·ªùng'}</b> ‚Äî Chu·ªói ${chuoiN.length} v√°n (y√™u c·∫ßu ${selectedLen}):</div>
                <div class="seq-text">${chuoiN.join("")}</div>
            </div>

            <div class="info-row" style="min-width:140px;">
                <div style="color:#aaa; font-size:12px; margin-bottom:4px;">K·∫øt qu·∫£ phi√™n tr∆∞·ªõc:</div>
                <div>üé≤ X√∫c x·∫Øc: <b>${lastDice.length ? lastDice.join(" - ") : "?"}</b> (T·ªïng <b class="${getMlsClass(kq_xx)}">${tong_xx !== null ? tong_xx : "?"}</b>)</div>
            </div>

            <div style="min-width:200px;">
                <div class="bar-container">
                    <div class="bar-tai" style="width: ${pt}%">${pt}%</div>
                    <div class="bar-xiu" style="width: ${px}%">${px}%</div>
                </div>
            </div>

            <div class="pred-grid" style="min-width:240px;">
                <div class="pred-box">
                    <div class="pred-title">üìä PH√ÇN T√çCH CHU·ªñI</div>
                    <div class="pred-value ${getMlsClass(kq_chuoi)}">${kq_chuoi}</div>
                </div>
                <div class="pred-box">
                    <div class="pred-title">üé≤ D·ª∞ ƒêO√ÅN X√öC X·∫ÆC</div>
                    <div class="pred-value ${getMlsClass(kq_xx)}">${kq_xx}</div>
                </div>
                <div class="pred-box pred-final">
                    <div class="pred-title">üî• CH·ªêT K·∫æT QU·∫¢ T·ªîNG H·ª¢P üî•</div>
                    <div class="pred-value ${getMlsClass(ket_qua)}">${ket_qua}</div>
                </div>
            </div>

            <div class="hint-box" style="min-width:160px;">
                üí° <b>G·ª£i √Ω ƒë√°nh:</b> <span style="color:#ffd700;">${hideSuggestion ? '‚Äî (b·ªã ·∫©n b·ªüi ng∆∞·ªùi d√πng)' : goi_y}</span>
            </div>

            <div style="margin-top:8px; font-size:12px; color:#cfcfcf;">
                <div><b>T√πy ch·ªçn ƒëang b·∫≠t:</b> ${invertChain ? 'B·∫ª chu·ªói; ' : ''}${invertFinal ? 'B·∫ª cu·ªëi; ' : ''}${skipDice ? 'B·ªè x√∫c x·∫Øc; ' : ''}${btnInvertAll.classList.contains('active') ? 'ƒê·∫£o to√†n b·ªô b·∫±ng n√∫t; ' : ''}${btnInvertChain.classList.contains('active') ? 'ƒê·∫£o chu·ªói b·∫±ng n√∫t; ' : ''}</div>
                <div style="margin-top:6px;"><b>Ch√∫ th√≠ch:</b> ${annotation ? annotation : '‚Äî'}</div>
            </div>
        `;

        if (cau_bip) {
            const warnHtml = document.createElement('div');
            warnHtml.className = 'info-row';
            warnHtml.style.border = '1px solid #ffb3b3';
            let more = '';
            if (cau_bip === "C·∫ßu b·ªát d√†i b·∫•t th∆∞·ªùng") more = "G·ª£i √Ω: ƒê·∫∑t ng∆∞·ª£c l·∫°i ho·∫∑c c√¢n nh·∫Øc kh√¥ng ƒë·∫∑t.";
            else if (cau_bip === "C·∫ßu nh·ª≠ ƒë·∫£o 1-1-2") more = "G·ª£i √Ω: ƒê·∫∑t theo chu k·ª≥ ƒë·∫£o ho·∫∑c b·ªè qua.";
            else if (cau_bip === "C·∫ßu b·∫´y l·∫∑p ƒë·ªÅu") more = "G·ª£i √Ω: ƒê·∫∑t theo xu h∆∞·ªõng m·ªõi ho·∫∑c ch·ªù th√™m k·∫øt qu·∫£.";
            warnHtml.innerHTML = `<div style="color:#ffdddd; font-weight:bold;">‚ö†Ô∏è C·∫¢NH B√ÅO: ${cau_bip}</div><div style="color:#ffd9b3; margin-top:6px;">${more}</div>`;
            resultBox.prepend(warnHtml);
        }

    } catch (error) {
        console.error(error);
        resultBox.innerHTML = `<div style='color:#ff4d4d; text-align:center;'>‚ö†Ô∏è L·ªói k·∫øt n·ªëi API ho·∫∑c CORS. H√£y m·ªü F12 xem chi ti·∫øt.</div>`;
    } finally {
        btn.innerHTML = "üîÑ C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU C·∫¶U";
        btn.style.opacity = "1";
    }
}

/* =========================
   UI: button toggles for "ƒê·∫£o c·∫ßu" buttons
   ========================= */
btnInvertAll.addEventListener('click', ()=>{
    btnInvertAll.classList.toggle('active');
});
btnInvertChain.addEventListener('click', ()=>{
    btnInvertChain.classList.toggle('active');
});

// Toggle n√¢ng cao (·∫©n/hi·ªán ph·∫ßn b·∫ª c·∫ßu + ƒë·∫£o c·∫ßu)
const btnAdvancedToggle = document.getElementById('btn-advanced-toggle');
const advancedSection = document.getElementById('advanced-section');
if(btnAdvancedToggle && advancedSection){
    btnAdvancedToggle.addEventListener('click', ()=>{
        const isHidden = advancedSection.style.display === 'none';
        advancedSection.style.display = isHidden ? 'block' : 'none';
        btnAdvancedToggle.textContent = isHidden ? '‚öô ·∫®n n√¢ng cao' : '‚öô N√¢ng cao';
    });
}

/* =========================
   UI: drag, scale, orientation (kept)
   ========================= */
const panel = document.getElementById("tool-panel");
const header = document.getElementById("panel-header");
let isOpen = true;
function toggleOrientation() {
    panel.classList.toggle('horizontal');
    const btn = document.getElementById('orientBtn');
    if (panel.classList.contains('horizontal')) btn.title = "Ch·∫ø ƒë·ªô ngang";
    else btn.title = "Ch·∫ø ƒë·ªô d·ªçc";
}
function changeScale(delta) {
    let current = parseFloat(getComputedStyle(panel).getPropertyValue('--panel-scale')) || 1;
    let next = Math.min(2, Math.max(0.6, +(current + delta).toFixed(2)));
    panel.style.setProperty('--panel-scale', next);
}
function resetScale() { panel.style.setProperty('--panel-scale', 1); }

let isDragging=false, offsetX=0, offsetY=0;
header.addEventListener('mousedown',(e)=>{ isDragging=true; const rect=panel.getBoundingClientRect(); offsetX = e.clientX - rect.left; offsetY = e.clientY - rect.top; panel.style.right='auto'; });
document.addEventListener('mousemove',(e)=>{ if(!isDragging) return; panel.style.left = (e.clientX - offsetX) + 'px'; panel.style.top = (e.clientY - offsetY) + 'px'; });
document.addEventListener('mouseup',()=>{ isDragging=false; });
header.addEventListener('touchstart',(ev)=>{ const t=ev.touches[0]; isDragging=true; const rect=panel.getBoundingClientRect(); offsetX=t.clientX-rect.left; offsetY=t.clientY-rect.top; panel.style.right='auto'; }, {passive:true});
document.addEventListener('touchmove',(ev)=>{ if(!isDragging) return; const t=ev.touches[0]; panel.style.left=(t.clientX-offsetX)+'px'; panel.style.top=(t.clientY-offsetY)+'px'; }, {passive:true});
document.addEventListener('touchend',()=>{ isDragging=false; });

window.addEventListener('load', ()=> {
    show(entryOverlay);
    hide(dashOverlay);
    hide(toolPanel);
    hide(gameFrame);
    if(window.innerWidth <= 720) toggleBtn.style.display='block'; else toggleBtn.style.display='none';
});
window.addEventListener('resize', ()=> { if(window.innerWidth <= 720) toggleBtn.style.display='block'; else toggleBtn.style.display='none'; });

</script>
</body>
</html>
